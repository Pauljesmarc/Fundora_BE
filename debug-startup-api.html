<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Startup API Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Startup API Debug Tool</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Authentication Test</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Email:</label>
                    <input type="email" id="email" value="test@startup.com" class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Password:</label>
                    <input type="password" id="password" value="password123" class="w-full border rounded px-3 py-2">
                </div>
            </div>
            
            <button onclick="testLogin()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                Test Login
            </button>
            
            <button onclick="testStartupsAPI()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 ml-2">
                Test Startups API
            </button>
            
            <button onclick="clearLogs()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 ml-2">
                Clear Logs
            </button>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Debug Output</h2>
            <div id="output" class="bg-gray-900 text-green-400 p-4 rounded font-mono text-sm h-96 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        const output = document.getElementById('output');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-400' : 
                         type === 'success' ? 'text-green-400' : 
                         type === 'warning' ? 'text-yellow-400' : 
                         'text-blue-400';
            
            output.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }
        
        function clearLogs() {
            output.innerHTML = '';
        }
        
        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            log('ðŸ” Testing login...', 'info');
            log(`Email: ${email}`, 'info');
            
            try {
                const response = await fetch('http://127.0.0.1:8000/api/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                log(`Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                log(`Response Headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`, 'info');
                
                const data = await response.json();
                log(`Response Data: ${JSON.stringify(data, null, 2)}`, response.ok ? 'success' : 'error');
                
                if (response.ok && data.access) {
                    localStorage.setItem('authToken', data.access);
                    log('âœ… Token saved to localStorage', 'success');
                } else {
                    log('âŒ Login failed', 'error');
                }
                
            } catch (error) {
                log(`âŒ Login Error: ${error.message}`, 'error');
                log(`Error Stack: ${error.stack}`, 'error');
            }
        }
        
        async function testStartupsAPI() {
            const token = localStorage.getItem('authToken');
            
            if (!token) {
                log('âŒ No auth token found. Please login first.', 'error');
                return;
            }
            
            log('ðŸš€ Testing startups API...', 'info');
            log(`Token: ${token.substring(0, 50)}...`, 'info');
            
            try {
                const response = await fetch('http://127.0.0.1:8000/api/startups/', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                
                log(`Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                log(`Response Headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`, 'info');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`Error Response: ${errorText}`, 'error');
                    return;
                }
                
                const data = await response.json();
                log(`Raw Response Type: ${typeof data}`, 'info');
                log(`Raw Response Keys: ${Object.keys(data)}`, 'info');
                log(`Full Response: ${JSON.stringify(data, null, 2)}`, 'success');
                
                // Analyze the data structure
                let startups = [];
                if (data.success && Array.isArray(data.startups)) {
                    startups = data.startups;
                    log(`âœ… Found ${startups.length} startups in data.startups`, 'success');
                } else if (Array.isArray(data)) {
                    startups = data;
                    log(`âœ… Found ${startups.length} startups in direct array`, 'success');
                } else {
                    log('âš ï¸ Unexpected data structure', 'warning');
                }
                
                // Analyze each startup for potential issues
                if (startups.length > 0) {
                    log('\\n--- Analyzing Startup Data ---', 'info');
                    startups.slice(0, 3).forEach((startup, index) => {
                        log(`\\nStartup ${index + 1}:`, 'info');
                        log(`  Type: ${typeof startup}`, 'info');
                        log(`  ID: ${startup?.id}`, 'info');
                        log(`  Company Name: "${startup?.company_name}" (${typeof startup?.company_name})`, 'info');
                        log(`  Industry: "${startup?.industry}" (${typeof startup?.industry})`, 'info');
                        
                        // Check for null values
                        const nullFields = [];
                        if (startup && typeof startup === 'object') {
                            Object.entries(startup).forEach(([key, value]) => {
                                if (value === null) nullFields.push(key);
                            });
                        }
                        
                        if (nullFields.length > 0) {
                            log(`  âš ï¸ NULL fields: ${nullFields.join(', ')}`, 'warning');
                        }
                        
                        // Check for empty strings that could cause charAt errors
                        if (startup?.company_name === '' || startup?.company_name === null) {
                            log(`  âŒ PROBLEM: Empty/null company_name will cause charAt error`, 'error');
                        }
                        if (startup?.industry === '' || startup?.industry === null) {
                            log(`  âŒ PROBLEM: Empty/null industry`, 'error');
                        }
                    });
                }
                
            } catch (error) {
                log(`âŒ API Error: ${error.message}`, 'error');
                log(`Error Stack: ${error.stack}`, 'error');
            }
        }
        
        // Auto-load on page load
        window.addEventListener('load', () => {
            log('ðŸŽ¯ Debug tool loaded. Ready for testing!', 'success');
            log('Instructions:', 'info');
            log('1. Click "Test Login" to authenticate', 'info');
            log('2. Click "Test Startups API" to check data', 'info');
            log('3. Look for any NULL or empty values that could cause "cannot read properties of null" errors', 'info');
        });
    </script>
</body>
</html>