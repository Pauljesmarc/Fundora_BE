<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="page-title">Company Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#eff6ff',
              100: '#dbeafe',
              200: '#bfdbfe',
              300: '#93c5fd',
              400: '#60a5fa',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8',
              800: '#1e40af',
              900: '#1e3a8a'
            },
            accent: {
              50: '#ecfdf5',
              100: '#d1fae5',
              200: '#a7f3d0',
              300: '#6ee7b7',
              400: '#34d399',
              500: '#10b981',
              600: '#059669',
              700: '#047857',
              800: '#065f46',
              900: '#064e3b'
            }
          },
          fontFamily: { 'sans': ['Inter', 'system-ui', 'sans-serif'] }
        }
      }
    };
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .hero-gradient { background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%); }
    .glass-card { background: rgba(15, 23, 42, 0.7); border: 1px solid rgba(148, 163, 184, 0.15); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideInLeft { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes slideInRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
    @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }

    .fade-in { animation: fadeIn 0.6s ease-out forwards; opacity: 0; }
    .slide-left { animation: slideInLeft 0.6s ease-out forwards; opacity: 0; }
    .slide-right { animation: slideInRight 0.6s ease-out forwards; opacity: 0; }
    .delay-1 { animation-delay: 0.1s; }
    .delay-2 { animation-delay: 0.2s; }
    .delay-3 { animation-delay: 0.3s; }
    .delay-4 { animation-delay: 0.4s; }

    .hover-lift { transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .hover-lift:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4); }

    .metric-card { transition: all 0.3s ease; }
    .metric-card:hover { transform: scale(1.05); background: rgba(59, 130, 246, 0.15); }
  </style>
</head>
<body class="bg-slate-950 text-white min-h-screen hero-gradient">
  <div class="max-w-7xl mx-auto p-6">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8 slide-left">
      <div class="flex items-center">
        <button id="backBtn" class="mr-6 p-2.5 hover:bg-slate-800/50 rounded-lg transition-all border border-slate-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        <div class="flex items-center">
          <div>
            <h1 id="companyName" class="text-3xl font-bold mb-2"></h1>
            <span id="industry" class="inline-block bg-brand-500/20 text-brand-300 text-sm font-medium px-4 py-1.5 rounded-full border border-brand-500/30"></span>
          </div>
        </div>
      </div>
      <span id="riskBadge" class="text-sm font-medium px-4 py-1.5 rounded-full"></span>
    </div>

    <!-- Changed grid layout from lg:col-span-2 and lg:col-span-1 to lg:grid-cols-3 for better balance -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left Column -->
      <div class="space-y-6 slide-left delay-1">
        <!-- Company Summary -->
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-6 fade-in delay-1">
          <h2 class="text-2xl font-semibold mb-4">Company Summary</h2>
          <p id="companyDescription" class="text-gray-300 leading-relaxed"></p>
        </div>

        <!-- Contact & Founder Info - Moved to Left Column -->
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-6 fade-in delay-2">
          <div class="flex items-center mb-6">
            <div class="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center mr-3">
              <svg class="w-5 h-5 text-purple-400" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
              </svg>
            </div>
            <h2 class="text-xl font-semibold">Contact Founder</h2>
          </div>
          <div id="contact-info" class="space-y-4"></div>
        </div>
      </div>

      <!-- Center Column -->
      <div class="space-y-6 slide-left delay-2">
        <!-- Financial Metrics -->
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-6 fade-in delay-2">
          <div class="flex items-center mb-6">
            <div class="w-10 h-10 bg-accent-500/20 rounded-lg flex items-center justify-center mr-3">
              <svg class="w-5 h-5 text-accent-400" fill="currentColor" viewBox="0 0 20 20">
                <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"></path>
              </svg>
            </div>
            <h2 class="text-2xl font-semibold">Financial Metrics</h2>
          </div>
          <div id="financials" class="grid grid-cols-2 gap-4"></div>
        </div>

        <!-- Risk & Reward -->
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-6 fade-in delay-3">
          <div class="flex items-center mb-6">
            <div class="w-10 h-10 bg-orange-500/20 rounded-lg flex items-center justify-center mr-3">
              <svg class="w-5 h-5 text-orange-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <h2 class="text-xl font-semibold">Risk & Reward</h2>
          </div>
          <div id="riskReward" class="space-y-5"></div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="space-y-6 slide-right delay-3">
        <!-- Qualitative Insights -->
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-6 fade-in delay-3">
          <h2 class="text-2xl font-semibold mb-6">Qualitative Insights</h2>
          <div id="qualitative"></div>
        </div>

        <!-- Data Confidence -->
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-6 fade-in delay-4">
          <div class="flex items-center mb-6">
            <div class="w-10 h-10 bg-brand-500/20 rounded-lg flex items-center justify-center mr-3">
              <svg class="w-5 h-5 text-brand-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <h2 class="text-xl font-semibold">Data Confidence</h2>
          </div>
          <div id="dataConfidence" class="text-center"></div>
        </div>

        <!-- View Analytics -->
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-6 fade-in delay-4" id="viewAnalyticsCard" style="display: none;">
          <div class="flex items-center mb-6">
            <div class="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center mr-3">
              <svg class="w-5 h-5 text-purple-400" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
              </svg>
            </div>
            <h2 class="text-xl font-semibold">Profile Views</h2>
          </div>
          <div id="viewAnalytics" class="grid grid-cols-2 gap-4"></div>
        </div>

        <!-- Action Buttons -->
        <div class="space-y-3 fade-in delay-4">
          <button id="watchlistBtn" class="w-full font-semibold py-3.5 px-4 rounded-lg transition-all duration-200 flex items-center justify-center" disabled>
            <svg class="w-5 h-5 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading...
          </button>
          <button id="compareBtn" class="w-full border border-slate-700 bg-slate-800/50 text-white hover:bg-slate-700/50 hover:border-slate-600 font-semibold py-3.5 px-4 rounded-lg transition-all duration-200 text-center">
            Compare Startups
          </button>

          <a id="investBtn" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-semibold py-3.5 px-4 rounded-lg transition-all duration-200 text-center block">
            Invest
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentWatchlistState = false;

    const token = sessionStorage.getItem("authToken") || localStorage.getItem("authToken");
    const params = new URLSearchParams(window.location.search);
    const startupId = params.get("id");
    const returnUrl = params.get("return");

    function authHeaders() {
        return token ? { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } : {};
    }

    function escapeHtml(unsafe) {
        if (unsafe === null || unsafe === undefined) return '';
        return String(unsafe)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    async function recordView() {
        try {
            const response = await fetch(`https://fundora-be-singapore.onrender.com/api/startups/${startupId}/view/`, {
                method: 'POST',
                headers: authHeaders()
            });
            
            if (response.ok) {
                const result = await response.json();
                console.log('View recorded successfully:', result);
                console.log('Total views:', result.total_views);
                console.log('Unique viewers:', result.unique_viewers);
            } else {
                const errorData = await response.json().catch(() => ({}));
                console.warn('Failed to record view:', response.status, errorData);
            }
        } catch (err) {
            console.error('Failed to record view:', err);
            // Don't block page loading if view recording fails
        }
    }

    async function loadCompany() {
        if (!startupId || !token) {
            alert('Missing startup ID or authentication');
            window.location.href = '../Module_1/Dashboard.html';
            return;
        }

        console.log('Loading company with ID:', startupId);

        // Record the view
        await recordView();

        try {
            const res = await fetch(`https://fundora-be-singapore.onrender.com/api/startups/${startupId}/`, {
                headers: authHeaders(),
            });
            
            if (!res.ok) {
                throw new Error('Failed to load startup data');
            }
            
            const responseData = await res.json();
            console.log('Startup API response:', responseData);
            
            // Handle DRF response format - extract startup data
            const data = responseData.startup || responseData;
            console.log('Startup data loaded:', data);
            console.log('Is in watchlist:', data.is_in_watchlist);

            document.title = `${data.company_name} - Company Profile`;
            document.getElementById("companyName").textContent = data.company_name;
            document.getElementById("industry").textContent = data.industry || "â€”";
            document.getElementById("companyDescription").textContent =
                data.company_description || "No description provided.";

            const badge = document.getElementById("riskBadge");
            const riskLevel = data.risk_level || "Data Pending";
            const hasDataPending = !data.risk_level;
            const riskMap = {
                Low: ["Low Risk", "bg-green-500/20 text-green-300 border border-green-500/30"],
                Medium: ["Medium Risk", "bg-yellow-500/20 text-yellow-300 border border-yellow-500/30"],
                High: ["High Risk", "bg-red-500/20 text-red-300 border border-red-500/30"],
            };
            const [label, classes] = riskMap[riskLevel] || ["Data Pending", "bg-gray-500/20 text-gray-300 border border-gray-500/30"];
            badge.textContent = label;
            badge.className = `${classes} text-sm font-medium px-4 py-1.5 rounded-full transition-all duration-300 hover:scale-105`;

            const fin = document.getElementById("financials");
            fin.innerHTML = `
                ${metric("accent","Revenue",data.revenue)}
                ${metric("brand","Net Income",data.net_income)}
                ${metric("orange","Total Assets",data.total_assets)}
                ${metric("purple","Cash Flow",data.cash_flow)}
            `;

            const qual = document.getElementById("qualitative");
            qual.innerHTML = section("Team Strength", data.team_strength) +
                            section("Market Position", data.market_position) +
                            section("Brand Reputation", data.brand_reputation);

            const rr = document.getElementById("riskReward");
            const reward = data.reward_potential;
            const riskScore = data.risk_score ?? 3; 
            
            console.log('Risk Score from backend:', riskScore);
            console.log('Reward Potential from backend:', reward);
            
            rr.innerHTML = barWithNull("Risk Score", riskScore, "red") + 
                          barWithNull("Reward Potential", reward, "brand");

            const confidencePercentage = data.confidence_percentage ?? 50;
            const dc = document.getElementById("dataConfidence");
            dc.innerHTML = `
                <div class="inline-flex items-center justify-center w-28 h-28 bg-brand-500/20 rounded-full mb-4 border-4 border-brand-500/30">
                    <span class="text-2xl font-bold text-brand-300">${confidencePercentage}%</span>
                </div>
                <p class="text-sm text-gray-400">Confidence Level: <strong class="text-white">${confidencePercentage}%</strong></p>
            `;

            const contactInfo = document.getElementById('contact-info');
            let contactHTML = '';

            // Founder Information
            if (data.founder_name) {
                contactHTML += `
                    <div class="pb-4 border-b border-slate-700/50">
                        <p class="text-xs text-gray-400 mb-1">Founder</p>
                        <p class="text-sm font-semibold text-white">${escapeHtml(data.founder_name)}</p>
                        ${data.founder_title ? `<p class="text-xs text-gray-400 mt-1">${escapeHtml(data.founder_title)}</p>` : ''}
                    </div>
                `;
            }

            // Contact Methods
            const contactMethods = [];
            
            if (data.contact_email) {
                contactMethods.push(`
                    <a href="mailto:${escapeHtml(data.contact_email)}" 
                       class="flex items-center text-brand-400 hover:text-brand-300 text-sm transition-colors group">
                        <svg class="w-4 h-4 mr-2 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                        </svg>
                        ${escapeHtml(data.contact_email)}
                    </a>
                `);
            }

            if (data.contact_phone) {
                contactMethods.push(`
                    <a href="tel:${escapeHtml(data.contact_phone)}" 
                       class="flex items-center text-brand-400 hover:text-brand-300 text-sm transition-colors group">
                        <svg class="w-4 h-4 mr-2 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                        </svg>
                        ${escapeHtml(data.contact_phone)}
                    </a>
                `);
            }

            if (data.website_url) {
                contactMethods.push(`
                    <a href="${escapeHtml(data.website_url)}" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       class="flex items-center text-brand-400 hover:text-brand-300 text-sm transition-colors group">
                        <svg class="w-4 h-4 mr-2 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z" clip-rule="evenodd"/>
                        </svg>
                        Visit Website
                        <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"/>
                            <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/>
                        </svg>
                    </a>
                `);
            }

            if (data.linkedin_url) {
                contactMethods.push(`
                    <a href="${escapeHtml(data.linkedin_url)}" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       class="flex items-center text-brand-400 hover:text-brand-300 text-sm transition-colors group">
                        <svg class="w-4 h-4 mr-2 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.338 16.338H13.67V12.16c0-.995-.017-2.277-1.387-2.277-1.39 0-1.601 1.086-1.601 2.207v4.248H8.014v-8.59h2.559v1.174h.037c.356-.675 1.227-1.387 2.526-1.387 2.703 0 3.203 1.778 3.203 4.092v4.711zM5.005 6.575a1.548 1.548 0 11-.003-3.096 1.548 1.548 0 01.003 3.096zm-1.337 9.763H6.34v-8.59H3.667v8.59zM17.668 1H2.328C1.595 1 1 1.581 1 2.298v15.403C1 18.418 1.595 19 2.328 19h15.34c.734 0 1.332-.582 1.332-1.299V2.298C19 1.581 18.402 1 17.668 1z" clip-rule="evenodd"/>
                        </svg>
                        Company LinkedIn
                        <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"/>
                            <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/>
                        </svg>
                    </a>
                `);
            }

            if (data.founder_linkedin) {
                contactMethods.push(`
                    <a href="${escapeHtml(data.founder_linkedin)}" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       class="flex items-center text-brand-400 hover:text-brand-300 text-sm transition-colors group">
                        <svg class="w-4 h-4 mr-2 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.338 16.338H13.67V12.16c0-.995-.017-2.277-1.387-2.277-1.39 0-1.601 1.086-1.601 2.207v4.248H8.014v-8.59h2.559v1.174h.037c.356-.675 1.227-1.387 2.526-1.387 2.703 0 3.203 1.778 3.203 4.092v4.711zM5.005 6.575a1.548 1.548 0 11-.003-3.096 1.548 1.548 0 01.003 3.096zm-1.337 9.763H6.34v-8.59H3.667v8.59zM17.668 1H2.328C1.595 1 1 1.581 1 2.298v15.403C1 18.418 1.595 19 2.328 19h15.34c.734 0 1.332-.582 1.332-1.299V2.298C19 1.581 18.402 1 17.668 1z" clip-rule="evenodd"/>
                        </svg>
                        Founder's LinkedIn
                        <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"/>
                            <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/>
                        </svg>
                    </a>
                `);
            }

            if (contactMethods.length > 0) {
                contactHTML += `
                    <div class="pb-4 border-b border-slate-700/50 space-y-3">
                        <p class="text-xs text-gray-400 mb-3">Contact Information</p>
                        ${contactMethods.join('')}
                    </div>
                `;
            }

            // Additional Info
            const additionalInfo = [];
            
            if (data.location) {
                additionalInfo.push(`
                    <div class="flex items-start">
                        <svg class="w-4 h-4 mr-2 text-gray-400 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                        </svg>
                        <div>
                            <p class="text-xs text-gray-400">Location</p>
                            <p class="text-sm text-white">${escapeHtml(data.location)}</p>
                        </div>
                    </div>
                `);
            }

            if (data.year_founded) {
                additionalInfo.push(`
                    <div class="flex items-start">
                        <svg class="w-4 h-4 mr-2 text-gray-400 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                        </svg>
                        <div>
                            <p class="text-xs text-gray-400">Founded</p>
                            <p class="text-sm text-white">${data.year_founded}</p>
                        </div>
                    </div>
                `);
            }

            if (additionalInfo.length > 0) {
                contactHTML += `
                    <div class="space-y-3">
                        <p class="text-xs text-gray-400 mb-3">Company Details</p>
                        ${additionalInfo.join('')}
                    </div>
                `;
            }

            // If no contact info available
            if (contactHTML === '') {
                contactHTML = `
                    <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-4 text-center">
                        <svg class="w-8 h-8 text-gray-500 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-gray-400 text-sm">Contact information not available</p>
                    </div>
                `;
            }

            contactInfo.innerHTML = contactHTML;

            // Display view analytics if available
            if (data.analytics && (data.analytics.total_views > 0 || data.analytics.unique_viewers > 0)) {
                const viewAnalyticsCard = document.getElementById('viewAnalyticsCard');
                const viewAnalytics = document.getElementById('viewAnalytics');
                
                viewAnalyticsCard.style.display = 'block';
                viewAnalytics.innerHTML = `
                    <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-purple-400 mb-1">${data.analytics.total_views || 0}</div>
                        <div class="text-sm text-gray-400">Total Views</div>
                    </div>
                    <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-purple-400 mb-1">${data.analytics.unique_viewers || 0}</div>
                        <div class="text-sm text-gray-400">Unique Viewers</div>
                    </div>
                `;
            }

            const isInWatchlist = data.is_in_watchlist === true;
            currentWatchlistState = isInWatchlist;
            console.log('Setting watchlist state to:', isInWatchlist);
            updateWatchlistButton(isInWatchlist);

            const investBtn = document.getElementById("investBtn");
            if (hasDataPending) {
                investBtn.className = "w-full bg-gray-500/20 text-gray-400 font-semibold py-3.5 px-4 rounded-lg cursor-not-allowed text-center block border border-gray-500/30";
                investBtn.style.pointerEvents = "none";
                investBtn.title = "Cannot invest - data pending";
                investBtn.removeAttribute("href");
            } else {
                const currentPath = window.location.pathname + window.location.search;
                investBtn.href = `../Module_2/Investment_Simulation.html?startup_id=${startupId}&return=${encodeURIComponent(currentPath)}`;
            }
            
            const compareBtn = document.getElementById("compareBtn");
            if (hasDataPending) {
                compareBtn.className = "w-full border border-gray-500/30 bg-gray-500/20 text-gray-400 font-semibold py-3.5 px-4 rounded-lg cursor-not-allowed text-center";
                compareBtn.disabled = true;
                compareBtn.title = "Cannot compare - data pending";
                compareBtn.style.pointerEvents = "none";
            }
        } catch (err) {
            console.error('Error loading company:', err);
            alert('Failed to load company profile');
        }
    }

    function updateWatchlistButton(inWatchlist) {
        const watchBtn = document.getElementById("watchlistBtn");
        watchBtn.disabled = false;

        if (inWatchlist) {
            watchBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 6 4 4 6.5 4c1.54 0 3.04.99 3.57 2.36h.87C13.46 4.99 14.96 4 16.5 4 19 4 21 6 21 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
                In Watchlist
            `;
            watchBtn.className = "w-full bg-slate-800/50 hover:bg-slate-700/50 text-white font-semibold py-3.5 px-4 rounded-lg flex items-center justify-center transition-all duration-200 border border-slate-700";
            watchBtn.onclick = () => toggleWatchlist(false);
        } else {
            watchBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                </svg>
                Add to Watchlist
            `;
            watchBtn.className = "w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3.5 px-4 rounded-lg flex items-center justify-center transition-all duration-200";
            watchBtn.onclick = () => toggleWatchlist(true);
        }
    }

    async function toggleWatchlist(shouldAdd) {
        const watchBtn = document.getElementById("watchlistBtn");
        if (!watchBtn) return;
        
        watchBtn.disabled = true;
        
        const originalHTML = watchBtn.innerHTML;
        watchBtn.innerHTML = `
            <svg class="w-5 h-5 mr-2 inline animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Updating...
        `;

        try {
            const action = shouldAdd ? 'add' : 'remove';
            
            console.log(`Attempting to ${action} startup ${startupId} to watchlist...`);
            
            const res = await fetch(`https://fundora-be-singapore.onrender.com/api/investor/watchlist/${action}/${startupId}/`, {
                method: 'POST',
                headers: authHeaders()
            });
            
            console.log('Response status:', res.status);
            
            if (!res.ok) {
                const errorText = await res.text();
                console.error('Response error:', errorText);
                throw new Error(`Failed to ${action} watchlist: ${res.status} ${errorText}`);
            }

            const result = await res.json();
            console.log('Watchlist response:', result);
            
            currentWatchlistState = result.added !== false && action === 'add' ? true : 
                                  result.success !== false && action === 'remove' ? false :
                                  currentWatchlistState;
            
            showNotification(result.message || `Watchlist ${shouldAdd ? 'added' : 'removed'} successfully`, 'success');
            
            updateWatchlistButton(action === 'add');
            
        } catch (err) {
            console.error('Watchlist toggle failed:', err);
            showNotification(err.message || 'Failed to update watchlist. Please try again.', 'error');
            
            watchBtn.innerHTML = originalHTML;
            watchBtn.disabled = false;
        }
    }

    function showNotification(message, type) {
        const div = document.createElement('div');
        div.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-2xl font-medium ${type === 'success' ? 'bg-accent-600' : 'bg-red-600'} text-white`;
        div.textContent = message;
        div.style.opacity = '0';
        document.body.appendChild(div);
        setTimeout(() => div.style.opacity = '1', 10);
        setTimeout(() => {
            div.style.opacity = '0';
            setTimeout(() => div.remove(), 300);
        }, 3000);
    }

    function metric(color, label, value) {
        const colorMap = {
            accent: { bg: 'bg-accent-500/10', border: 'border-accent-500/30', text: 'text-accent-400' },
            brand: { bg: 'bg-brand-500/10', border: 'border-brand-500/30', text: 'text-brand-400' },
            orange: { bg: 'bg-orange-500/10', border: 'border-orange-500/30', text: 'text-orange-400' },
            purple: { bg: 'bg-purple-500/10', border: 'border-purple-500/30', text: 'text-purple-400' }
        };
        const colors = colorMap[color];
        return `
            <div class="${colors.bg} border ${colors.border} rounded-lg p-4 text-center metric-card">
                <div class="text-2xl font-bold ${colors.text} mb-1">${value ?? "N/A"}</div>
                <div class="text-sm text-gray-400">${label}</div>
            </div>`;
    }

    function section(title, text) {
        return `
            <div class="mb-5 pb-5 border-b border-slate-800 last:border-0 last:pb-0 last:mb-0">
                <span class="text-white font-semibold text-sm block mb-2">${title}</span>
                <p class="text-gray-400 text-sm">${text ?? "No data"}</p>
            </div>`;
    }

    function barWithNull(label, score, color) {
        const colorClass = color === 'red' ? 'bg-red-500' : 'bg-brand-500';
        
        if (score === null || score === undefined) {
            return `
                <div>
                    <div class="flex justify-between text-sm mb-2">
                        <p class="text-gray-300 font-medium">${label}</p>
                        <p class="font-semibold text-gray-500">N/A</p>
                    </div>
                    <div class="w-full bg-slate-800/50 rounded-full h-2.5">
                        <div class="bg-gray-600 h-2.5 rounded-full" style="width:0%"></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1.5">Insufficient data</p>
                </div>`;
        }
        
        return `
            <div>
                <div class="flex justify-between text-sm mb-2">
                    <p class="text-gray-300 font-medium">${label}</p>
                    <p class="font-semibold text-white">${score}/5</p>
                </div>
                <div class="w-full bg-slate-800/50 rounded-full h-2.5">
                    <div class="${colorClass} h-2.5 rounded-full transition-all duration-500" style="width:${(score / 5) * 100}%"></div>
                </div>
            </div>`;
    }

    function bar(label, score, color) {
        const colorClass = color === 'red' ? 'bg-red-500' : 'bg-brand-500';
        return `
            <div>
                <div class="flex justify-between text-sm mb-2">
                    <p class="text-gray-300 font-medium">${label}</p>
                    <p class="font-semibold text-white">${score}/5</p>
                </div>
                <div class="w-full bg-slate-800/50 rounded-full h-2.5">
                    <div class="${colorClass} h-2.5 rounded-full transition-all duration-500" style="width:${(score / 5) * 100}%"></div>
                </div>
            </div>`;
    }

    document.getElementById('backBtn').addEventListener('click', () => {
        if (returnUrl) {
            window.location.href = returnUrl;
        } else {
            window.location.href = '../Module_1/Dashboard.html';
        }
    });

    document.getElementById('compareBtn').addEventListener('click', () => {
        const currentPath = window.location.pathname + window.location.search;
        window.location.href = `../Module_2/Compare_Startups.html?return=${encodeURIComponent(currentPath)}`;
    });

    document.addEventListener("DOMContentLoaded", loadCompany);
  </script>
</body>
</html>