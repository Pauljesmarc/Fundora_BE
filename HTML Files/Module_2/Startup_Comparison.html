<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Startup Comparison</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#eff6ff',
              100: '#dbeafe',
              200: '#bfdbfe',
              300: '#93c5fd',
              400: '#60a5fa',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8',
              800: '#1e40af',
              900: '#1e3a8a'
            },
            accent: {
              50: '#ecfdf5',
              100: '#d1fae5',
              200: '#a7f3d0',
              300: '#6ee7b7',
              400: '#34d399',
              500: '#10b981',
              600: '#059669',
              700: '#047857',
              800: '#065f46',
              900: '#064e3b'
            }
          },
          fontFamily: { 'sans': ['Inter', 'system-ui', 'sans-serif'] }
        }
      }
    };
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .hero-gradient { background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%); }
    @keyframes fadeIn { 
    from { opacity: 0; transform: translateY(20px); } 
    to { opacity: 1; transform: translateY(0); } 
    }
    @keyframes slideInLeft { 
      from { opacity: 0; transform: translateX(-25px); } 
      to { opacity: 1; transform: translateX(0); } 
    }
    @keyframes slideInRight { 
      from { opacity: 0; transform: translateX(25px); } 
      to { opacity: 1; transform: translateX(0); } 
    }
    @keyframes scaleIn { 
      from { opacity: 0; transform: scale(0.95); } 
      to { opacity: 1; transform: scale(1); } 
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
      50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
    }

    .fade-in { 
      animation: fadeIn 0.6s ease-out forwards; 
      opacity: 0;
    }
    .slide-left { 
      animation: slideInLeft 0.6s ease-out forwards; 
      opacity: 0;
    }
    .slide-right { 
      animation: slideInRight 0.6s ease-out forwards; 
      opacity: 0;
    }
    .scale-in { 
      animation: scaleIn 0.6s ease-out forwards; 
      opacity: 0;
    }
    .delay-1 { animation-delay: 0.1s; }
    .delay-2 { animation-delay: 0.2s; }
    .delay-3 { animation-delay: 0.3s; }

    .chart-container { contain: layout style paint; }

    .card-hover {
      transition: all 0.3s ease;
    }
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
      border-color: rgba(59, 130, 246, 0.4) !important;
    }

    .stat-card-hover {
      transition: all 0.3s ease;
    }
    .stat-card-hover:hover {
      transform: scale(1.05);
      background-color: rgba(30, 41, 59, 0.8);
    }

    .table-row-hover {
      transition: all 0.2s ease;
    }
    .table-row-hover:hover {
      background-color: rgba(59, 130, 246, 0.08) !important;
      transform: translateX(4px);
    }

    .btn-pulse {
      animation: pulse-glow 2.5s infinite;
    }
  </style>
</head>
<body class="bg-slate-950 text-white min-h-screen hero-gradient">
  <header class="bg-slate-900 border-b border-slate-800 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center">
          <a id="back-nav-link" href="#" class="flex items-center text-gray-300 hover:text-white font-medium transition-colors duration-200">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            <span id="back-nav-text">Back to Watchlist</span>
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Notification Toast -->
  <div id="notification" class="hidden fixed top-20 right-6 z-50 max-w-sm">
    <div class="bg-slate-900 rounded-lg shadow-2xl border-l-4 p-4 border border-slate-700">
      <div class="flex items-center">
        <div id="notification-icon" class="flex-shrink-0"></div>
        <div class="ml-3">
          <p id="notification-message" class="text-sm font-medium text-white"></p>
        </div>
        <button onclick="hideNotification()" class="ml-auto flex-shrink-0 text-gray-400 hover:text-gray-200">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <main class="bg-slate-950 min-h-screen pb-12">
    <div class="max-w-7xl mx-auto p-6">
      <!-- Header -->
      <div class="flex justify-between items-center mb-8 slide-left">
        <div>
          <h1 class="text-3xl font-bold text-white">Startup Comparison</h1>
          <p id="comparison-count" class="text-gray-400 mt-1">Loading comparison...</p>
        </div>
        <div id="back-to-selection-container" class="hidden flex gap-3">
          <a href="Compare_Startups.html" class="text-gray-300 hover:text-white font-medium flex items-center">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Back to Selection
          </a>
        </div>
      </div>

      <!-- Loading State -->
      <div id="loading-state" class="text-center py-16 fade-in">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-brand-500 mx-auto mb-4"></div>
        <p class="text-gray-400">Loading startup data...</p>
      </div>

      <!-- Error State -->
      <div id="error-state" class="hidden text-center py-16 fade-in">
        <div class="text-4xl font-bold text-red-500 mb-4">Error</div>
        <h3 class="text-xl font-semibold text-white mb-2">Failed to load comparison</h3>
        <p class="text-gray-400 mb-6">Please try again or select different startups</p>
        <a href="Compare_Startups.html" class="bg-brand-600 hover:bg-brand-700 text-white font-medium py-2 px-6 rounded-lg transition-colors">
          Back to Selection
        </a>
      </div>

      <!-- Company Headers -->
      <div id="comparison-header" class="hidden grid gap-6 mb-8"></div>

      <!-- Comparison Analytics -->
      <div id="comparison-analytics" class="hidden bg-slate-900 border border-slate-800 rounded-2xl p-6 mb-8 fade-in delay-1 card-hover">
        <h2 class="text-xl font-bold text-white mb-6">Comparison Analytics</h2>
        <div id="comparison-analytics-content" class="grid gap-6"></div>
      </div>

      <!-- Quick Stats Overview -->
      <div id="quick-stats" class="hidden bg-slate-900 border border-slate-800 rounded-2xl p-6 mb-8 scale-in delay-1 card-hover">
        <h2 class="text-xl font-bold text-white mb-6">Quick Overview</h2>
        <div id="quick-stats-content" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
      </div>

      <!-- Visual Comparison Charts -->
      <div id="charts-section" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6 slide-left delay-2 chart-container card-hover">
          <h3 class="text-lg font-semibold text-white mb-4">Projected Returns</h3>
          <canvas id="returns-chart"></canvas>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6 slide-right delay-2 chart-container card-hover">
          <h3 class="text-lg font-semibold text-white mb-4">Risk vs Reward</h3>
          <canvas id="risk-reward-chart"></canvas>
        </div>
      </div>

      <!-- Detailed Comparison Table -->
      <div id="comparison-table-section" class="hidden bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden mb-8 scale-in delay-3 card-hover">
        <div class="p-6 border-b border-slate-800">
          <h2 class="text-xl font-bold text-white">Detailed Comparison</h2>
        </div>
        <div class="overflow-x-auto">
          <table id="comparison-table" class="w-full"></table>
        </div>
      </div>

      <div class="flex justify-center fade-in delay-3">
        <button id="save-comparison-btn" onclick="toggleSaveComparison()" class="hidden bg-brand-600 hover:bg-brand-700 text-white font-medium py-3 px-8 rounded-lg transition-all duration-200 items-center shadow-lg btn-pulse transform hover:scale-105 active:scale-95">
          <svg id="save-icon" class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          <span id="save-text">Save Comparison</span>
        </button>
      </div>
    </div>
  </main>

  <script>
    const domCache = {
      notification: document.getElementById('notification'),
      notificationMessage: document.getElementById('notification-message'),
      notificationIcon: document.getElementById('notification-icon'),
      loadingState: document.getElementById('loading-state'),
      errorState: document.getElementById('error-state'),
      comparisonHeader: document.getElementById('comparison-header'),
      quickStats: document.getElementById('quick-stats'),
      chartsSection: document.getElementById('charts-section'),
      comparisonTableSection: document.getElementById('comparison-table-section'),
      saveBtn: document.getElementById('save-comparison-btn'),
      saveText: document.getElementById('save-text'),
      saveIcon: document.getElementById('save-icon'),
      comparissonCount: document.getElementById('comparison-count')
    };

    const API_BASE = 'https://fundora-be-singapore.onrender.com/api';
    const STARTUPS_ENDPOINT = `${API_BASE}/startups/`;
    const SAVE_COMPARISON_ENDPOINT = `${API_BASE}/investor/comparisons/save/`;
    const CHECK_COMPARISON_ENDPOINT = `${API_BASE}/investor/comparisons/`;
    const RECORD_COMPARISON_ENDPOINT = `${API_BASE}/analytics/comparison/`;

    let startupsData = [];
    let currentComparisonIds = [];
    let returnsChart = null;
    let riskRewardChart = null;
    let isComparisonSaved = false;
    let savedComparisonId = null;

    function getAuthToken() {
      return sessionStorage.getItem('authToken');
    }

    function authHeaders() {
      const token = getAuthToken();
      if (!token) return {};
      return { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
    }

    function escapeHtml(unsafe) {
      if (unsafe === null || unsafe === undefined) return 'â€”';
      return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function showNotification(message, type = 'success') {
      domCache.notificationMessage.textContent = message;
      
      if (type === 'success') {
        domCache.notification.querySelector('.border-l-4').classList.remove('border-red-500', 'border-yellow-500');
        domCache.notification.querySelector('.border-l-4').classList.add('border-accent-500');
        domCache.notificationIcon.innerHTML = `
          <svg class="w-6 h-6 text-accent-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
        `;
      } else if (type === 'error') {
        domCache.notification.querySelector('.border-l-4').classList.remove('border-accent-500', 'border-yellow-500');
        domCache.notification.querySelector('.border-l-4').classList.add('border-red-500');
        domCache.notificationIcon.innerHTML = `
          <svg class="w-6 h-6 text-red-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
          </svg>
        `;
      } else {
        domCache.notification.querySelector('.border-l-4').classList.remove('border-accent-500', 'border-red-500');
        domCache.notification.querySelector('.border-l-4').classList.add('border-yellow-500');
        domCache.notificationIcon.innerHTML = `
          <svg class="w-6 h-6 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
        `;
      }
      
      domCache.notification.classList.remove('hidden');
      
      setTimeout(() => {
        hideNotification();
      }, 4000);
    }

    function hideNotification() {
      domCache.notification.classList.add('hidden');
    }

    async function recordComparison(startupIds) {
      try {
        console.log('ðŸ“¤ Recording comparison...');
        console.log('  Endpoint:', RECORD_COMPARISON_ENDPOINT);
        console.log('  Startup IDs:', startupIds);
        console.log('  Auth token:', getAuthToken() ? 'âœ“ Present' : 'âœ— Missing');
        
        const response = await fetch(RECORD_COMPARISON_ENDPOINT, {
          method: 'POST',
          headers: authHeaders(),
          body: JSON.stringify({ startup_ids: startupIds })
        });

        console.log('ðŸ“¥ Response status:', response.status, response.statusText);
        console.log('ðŸ“¥ Response URL:', response.url);

        if (response.ok) {
          const result = await response.json();
          console.log('âœ… Comparison recorded successfully:', result);
          console.log('ðŸ“Š Comparison set ID:', result.comparison_set_id);
          
          // Log analytics for each startup
          console.log('\nðŸ“ˆ Comparison Analytics:');
          for (const startupId of startupIds) {
            console.log(`\nStartup ${startupId}:`);
            console.log(`  ðŸ“Š Total comparisons: ${result.total_comparisons[startupId]}`);
            console.log(`  ðŸ‘¥ Unique comparers: ${result.unique_comparers[startupId]}`);
          }
          
          return result;
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('âŒ Failed to record comparison:');
          console.error('  Status:', response.status);
          console.error('  Status Text:', response.statusText);
          console.error('  URL:', response.url);
          console.error('  Error data:', errorData);
          return null;
        }
      } catch (err) {
        console.error('âŒ Exception while recording comparison:', err);
        console.error('  Error type:', err.name);
        console.error('  Error message:', err.message);
        // Don't block page loading if comparison recording fails
        return null;
      }
    }

    async function checkIfComparisonExists() {
      try {
        const response = await fetch(CHECK_COMPARISON_ENDPOINT, {
          method: 'GET',
          headers: authHeaders()
        });

        if (!response.ok) return { exists: false, id: null };

        const data = await response.json();
        const comparisons = data.results || [];
        
        const sortedCurrent = [...currentComparisonIds].sort((a, b) => a - b);
        
        for (const comp of comparisons) {
          const compIds = comp.startups.map(s => s.id).sort((a, b) => a - b);
          
          if (JSON.stringify(sortedCurrent) === JSON.stringify(compIds)) {
            return { exists: true, id: comp.id };
          }
        }
        
        return { exists: false, id: null };
      } catch (error) {
        console.error('Error checking comparison:', error);
        return { exists: false, id: null };
      }
    }

    function updateSaveButton(isSaved) {
      domCache.saveBtn.disabled = false;
      
      if (isSaved) {
        domCache.saveText.textContent = 'Unsave Comparison';
        domCache.saveIcon.innerHTML = `
          <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        `;
        domCache.saveBtn.classList.remove('bg-brand-600', 'hover:bg-brand-700');
        domCache.saveBtn.classList.add('bg-slate-800', 'hover:bg-slate-700', 'border', 'border-slate-700');
      } else {
        domCache.saveText.textContent = 'Save Comparison';
        domCache.saveIcon.innerHTML = `
          <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        `;
        domCache.saveBtn.classList.remove('bg-slate-800', 'hover:bg-slate-700', 'border', 'border-slate-700');
        domCache.saveBtn.classList.add('bg-brand-600', 'hover:bg-brand-700');
      }
    }

    async function toggleSaveComparison() {
      if (isComparisonSaved) {
        await unsaveComparison();
      } else {
        await saveComparison();
      }
    }

    async function saveComparison() {
      if (!currentComparisonIds || currentComparisonIds.length < 2) {
        showNotification('Cannot save comparison: Not enough startups selected', 'error');
        return;
      }

      domCache.saveBtn.disabled = true;
      domCache.saveText.textContent = 'Saving...';
      domCache.saveIcon.innerHTML = `
        <svg class="animate-spin w-5 h-5 mr-2 inline" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      `;

      try {
        const response = await fetch(SAVE_COMPARISON_ENDPOINT, {
          method: 'POST',
          headers: authHeaders(),
          body: JSON.stringify({ startup_ids: currentComparisonIds })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Failed to save comparison' }));
          throw new Error(errorData.error || 'Failed to save comparison');
        }

        const data = await response.json();
        isComparisonSaved = true;
        savedComparisonId = data.id || data.comparison_id;
        
        if (data.already_exists) {
          showNotification('This comparison is already in your watchlist', 'info');
        } else {
          showNotification('Comparison saved to your watchlist!', 'success');
        }
        
        updateSaveButton(true);
      } catch (error) {
        console.error('Error saving comparison:', error);
        showNotification(error.message || 'Failed to save comparison', 'error');
        updateSaveButton(false);
      }
    }

    async function unsaveComparison() {
      if (!savedComparisonId) {
        showNotification('Cannot unsave: Comparison ID not found', 'error');
        return;
      }

      domCache.saveBtn.disabled = true;
      domCache.saveText.textContent = 'Removing...';
      domCache.saveIcon.innerHTML = `
        <svg class="animate-spin w-5 h-5 mr-2 inline" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      `;

      try {
        const deleteUrl = `${API_BASE}/api/investor/comparisons/delete/${savedComparisonId}/`;
        
        const response = await fetch(deleteUrl, {
          method: 'DELETE',
          headers: authHeaders()
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || 'Failed to unsave comparison');
        }

        isComparisonSaved = false;
        savedComparisonId = null;
        
        showNotification('Comparison removed from your watchlist', 'success');
        updateSaveButton(false);
      } catch (error) {
        console.error('Error unsaving comparison:', error);
        showNotification(error.message || 'Failed to unsave comparison', 'error');
        updateSaveButton(true);
      }
    }

    async function fetchStartupById(id) {
      try {
        const response = await fetch(`${STARTUPS_ENDPOINT}${id}/`, {
          headers: authHeaders()
        });
        if (!response.ok) throw new Error(`Failed to fetch startup ${id}`);
        return await response.json();
      } catch (error) {
        console.error(`Error fetching startup ${id}:`, error);
        return null;
      }
    }

    async function loadComparison() {
      const urlParams = new URLSearchParams(window.location.search);
      const startupsParam = urlParams.get('startups');

      if (!startupsParam) {
        showError('No startups selected for comparison');
        return;
      }

      const startupIds = startupsParam.split(',').filter(id => id.trim());
      currentComparisonIds = startupIds.map(id => parseInt(id));
      
      if (startupIds.length < 2) {
        showError('Please select at least 2 startups to compare');
        return;
      }

      domCache.comparissonCount.textContent = 
        `Comparing ${startupIds.length} startup${startupIds.length > 1 ? 's' : ''}`;

      try {
        const promises = startupIds.map(id => fetchStartupById(id));
        const results = await Promise.all(promises);
        startupsData = results.filter(s => s !== null);

        if (startupsData.length === 0) {
          showError('Failed to load startup data');
          return;
        }

        // Record the comparison
        await recordComparison(currentComparisonIds);

        // Refetch startup data to get updated analytics
        console.log('ðŸ”„ Refetching startup data to get updated analytics...');
        const refetchPromises = startupIds.map(id => fetchStartupById(id));
        const refetchResults = await Promise.all(refetchPromises);
        startupsData = refetchResults.filter(s => s !== null);
        console.log('âœ… Startup data refetched with updated analytics');

        domCache.loadingState.classList.add('hidden');
        
        const result = await checkIfComparisonExists();
        
        domCache.saveBtn.classList.remove('hidden');
        
        if (result.exists) {
          isComparisonSaved = true;
          savedComparisonId = result.id;
          updateSaveButton(true);
        } else {
          isComparisonSaved = false;
          savedComparisonId = null;
          updateSaveButton(false);
        }
        
        renderComparison();
      } catch (error) {
        console.error('Error loading comparison:', error);
        showError('An error occurred while loading the comparison');
      }
    }

    function showError(message) {
      domCache.loadingState.classList.add('hidden');
      domCache.errorState.classList.remove('hidden');
      domCache.errorState.querySelector('p').textContent = message;
    }

    function renderComparison() {
      renderHeaders();
      renderComparisonAnalytics();
      renderQuickStats();
      renderCharts();
      renderComparisonTable();
      
      domCache.comparisonHeader.classList.remove('hidden');
      document.getElementById('comparison-analytics').classList.remove('hidden');
      domCache.quickStats.classList.remove('hidden');
      domCache.chartsSection.classList.remove('hidden');
      domCache.comparisonTableSection.classList.remove('hidden');
    }

    function renderComparisonAnalytics() {
      const container = document.getElementById('comparison-analytics-content');
      container.className = `grid grid-cols-1 md:grid-cols-${startupsData.length} gap-6`;
      container.innerHTML = '';

      console.log('\nðŸŽ¨ Rendering Comparison Analytics:');
      
      startupsData.forEach((startup, idx) => {
        const analytics = startup.analytics || {};
        const totalComparisons = analytics.total_comparisons || 0;
        const uniqueComparers = analytics.unique_comparers || 0;
        const recentComparisons = analytics.recent_comparisons || 0;
        
        console.log(`\n${startup.company_name}:`);
        console.log(`  ðŸ“Š Total Comparisons: ${totalComparisons}`);
        console.log(`  ðŸ‘¥ Unique Comparers: ${uniqueComparers}`);
        console.log(`  ðŸ“… Recent Comparisons (30d): ${recentComparisons}`);

        const card = document.createElement('div');
        card.className = 'bg-slate-800/50 border border-slate-700 rounded-xl p-5';
        card.style.animationDelay = `${idx * 0.1}s`;
        card.innerHTML = `
          <h3 class="text-lg font-semibold text-white mb-4">${escapeHtml(startup.company_name)}</h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg">
              <div class="flex items-center">
                <svg class="w-5 h-5 text-blue-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                  <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                </svg>
                <span class="text-sm text-gray-400">Total Comparisons</span>
              </div>
              <span class="text-2xl font-bold text-blue-400">${totalComparisons}</span>
            </div>
            <div class="flex justify-between items-center p-3 bg-purple-500/10 border border-purple-500/30 rounded-lg">
              <div class="flex items-center">
                <svg class="w-5 h-5 text-purple-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                </svg>
                <span class="text-sm text-gray-400">Unique Comparers</span>
              </div>
              <span class="text-2xl font-bold text-purple-400">${uniqueComparers}</span>
            </div>
            ${recentComparisons > 0 ? `
              <div class="flex justify-between items-center p-2 bg-slate-700/30 rounded-lg">
                <span class="text-xs text-gray-400">Last 30 days</span>
                <span class="text-sm font-semibold text-gray-300">${recentComparisons} comparisons</span>
              </div>
            ` : ''}
          </div>
        `;
        container.appendChild(card);
      });
    }

    function renderHeaders() {
      const container = domCache.comparisonHeader;
      container.className = `grid grid-cols-1 md:grid-cols-${startupsData.length} gap-6 mb-8`;
      container.innerHTML = '';

      startupsData.forEach(startup => {
        const isDeck = !!(startup.is_deck_builder || startup.source_deck_id || startup.source_deck);
        
        let riskBadge;
        if (isDeck) {
          riskBadge = '<span class="bg-brand-500/20 text-brand-300 border border-brand-500/30 text-xs font-medium px-2 py-1 rounded-full">Pitch Deck</span>';
        } else if (startup.risk_level) {
          const riskLevel = startup.risk_level.toLowerCase();
          if (riskLevel === 'low') {
            riskBadge = '<span class="bg-accent-500/20 text-accent-300 border border-accent-500/30 text-xs font-medium px-2 py-1 rounded-full">Low Risk</span>';
          } else if (riskLevel === 'medium') {
            riskBadge = '<span class="bg-yellow-500/20 text-yellow-300 border border-yellow-500/30 text-xs font-medium px-2 py-1 rounded-full">Medium Risk</span>';
          } else {
            riskBadge = '<span class="bg-red-500/20 text-red-300 border border-red-500/30 text-xs font-medium px-2 py-1 rounded-full">High Risk</span>';
          }
        } else {
          riskBadge = '<span class="bg-gray-500/20 text-gray-300 border border-gray-500/30 text-xs font-medium px-2 py-1 rounded-full">Risk N/A</span>';
        }

        const card = document.createElement('div');
        card.className = 'bg-slate-900 border border-slate-800 rounded-2xl p-6 card-hover fade-in';
        card.style.animationDelay = `${startupsData.indexOf(startup) * 0.1}s`;
        card.innerHTML = `
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="text-xl font-bold text-white mb-2">${escapeHtml(startup.company_name)}</h3>
              <p class="text-sm text-gray-400">${escapeHtml(startup.industry || 'Not specified')}</p>
            </div>
            ${riskBadge}
          </div>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-sm text-gray-400">Estimated Growth Rate</span>
              <span class="text-sm font-bold ${startup.estimated_growth_rate != null && startup.estimated_growth_rate >= 0 ? 'text-accent-400' : 'text-red-400'}">
                ${startup.estimated_growth_rate != null ? (startup.estimated_growth_rate >= 0 ? '+' : '') + startup.estimated_growth_rate + '%' : 'N/A'}
              </span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-gray-400">Reward Potential</span>
              <span class="text-sm font-bold text-white">${getRewardValue(startup.reward_potential)}/5</span>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function getRewardValue(reward) {
      if (reward == null) return 'N/A';
      if (typeof reward === 'string') return reward.split(',')[0].trim();
      if (Array.isArray(reward)) return reward[0];
      return String(reward);
    }

    function renderQuickStats() {
      const container = document.getElementById('quick-stats-content');
      container.innerHTML = '';

      const highestGrowth = [...startupsData].sort((a, b) => 
        (b.estimated_growth_rate || 0) - (a.estimated_growth_rate || 0)
      )[0];

      const bestReward = [...startupsData].sort((a, b) => {
        const aVal = parseFloat(getRewardValue(a.reward_potential)) || 0;
        const bVal = parseFloat(getRewardValue(b.reward_potential)) || 0;
        return bVal - aVal;
      })[0];

      const lowestRisk = startupsData.find(s => s.risk_level === 'Low') || startupsData[0];

      const stats = [
        {
          title: 'Highest Estimated Growth',
          company: highestGrowth.company_name,
          value: highestGrowth.estimated_growth_rate != null ? `${highestGrowth.estimated_growth_rate >= 0 ? '+' : ''}${highestGrowth.estimated_growth_rate}%` : 'N/A',
          color: 'text-accent-400'
        },
        {
          title: 'Best Reward Potential',
          company: bestReward.company_name,
          value: `${getRewardValue(bestReward.reward_potential)}/5`,
          color: 'text-brand-400'
        },
        {
          title: 'Lowest Risk',
          company: lowestRisk.company_name,
          value: lowestRisk.risk_level || 'N/A',
          color: 'text-accent-400'
        }
      ];

      stats.forEach(stat => {
        const statCard = document.createElement('div');
        statCard.className = 'text-center p-4 bg-slate-800 rounded-lg border border-slate-700 stat-card-hover';
        statCard.innerHTML = `
          <p class="text-sm text-gray-400 mb-1">${stat.title}</p>
          <p class="text-lg font-bold text-white mb-1">${escapeHtml(stat.company)}</p>
          <p class="text-2xl font-bold ${stat.color}">${stat.value}</p>
        `;
        container.appendChild(statCard);
      });
    }

    function renderCharts() {
      const returnsCtx = document.getElementById('returns-chart').getContext('2d');
      if (returnsChart) returnsChart.destroy();
      
      returnsChart = new Chart(returnsCtx, {
        type: 'bar',
        data: {
          labels: startupsData.map(s => s.company_name),
          datasets: [{
            label: 'Estimated Growth Rate (%)',
            data: startupsData.map(s => s.estimated_growth_rate || 0),
            backgroundColor: startupsData.map(s => 
              s.projected_return >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(248, 113, 113, 0.8)'
            ),
            borderColor: startupsData.map(s => 
              s.projected_return >= 0 ? 'rgb(16, 185, 129)' : 'rgb(248, 113, 113)'
            ),
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          animation: { duration: 0 },
          plugins: {
            legend: { 
              display: false 
            },
            tooltip: {
              backgroundColor: 'rgba(15, 23, 42, 0.9)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: 'rgba(148, 163, 184, 0.2)',
              borderWidth: 1,
              callbacks: {
                label: function(context) {
                  return `Return: ${context.parsed.y >= 0 ? '+' : ''}${context.parsed.y}%`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(148, 163, 184, 0.1)'
              },
              ticks: {
                color: '#94a3b8'
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(148, 163, 184, 0.1)'
              },
              ticks: {
                color: '#94a3b8',
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          }
        }
      });

      const riskRewardCtx = document.getElementById('risk-reward-chart').getContext('2d');
      if (riskRewardChart) riskRewardChart.destroy();

      const riskMap = { 'High': 1, 'Medium': 2, 'Low': 3 };
      
      riskRewardChart = new Chart(riskRewardCtx, {
        type: 'scatter',
        data: {
          datasets: startupsData.map((s, idx) => ({
            label: s.company_name,
            data: [{
              x: riskMap[s.risk_level] || 2,
              y: parseFloat(getRewardValue(s.reward_potential)) || 0
            }],
            backgroundColor: ['rgba(59, 130, 246, 0.8)', 'rgba(16, 185, 129, 0.8)', 'rgba(245, 158, 11, 0.8)'][idx % 3],
            borderColor: ['rgb(59, 130, 246)', 'rgb(16, 185, 129)', 'rgb(245, 158, 11)'][idx % 3],
            borderWidth: 2,
            pointRadius: 8,
            pointHoverRadius: 10
          }))
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          animation: { duration: 0 },
          plugins: {
            legend: { 
              position: 'bottom',
              labels: {
                color: '#94a3b8',
                padding: 15
              }
            },
            tooltip: {
              backgroundColor: 'rgba(15, 23, 42, 0.9)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: 'rgba(148, 163, 184, 0.2)',
              borderWidth: 1,
              callbacks: {
                label: function(context) {
                  const riskLabels = ['', 'High Risk', 'Medium Risk', 'Low Risk'];
                  return `${context.dataset.label}: ${riskLabels[context.parsed.x]}, Reward: ${context.parsed.y}/5`;
                }
              }
            }
          },
          scales: {
            x: {
              title: { 
                display: true, 
                text: 'Risk Level',
                color: '#94a3b8'
              },
              grid: {
                color: 'rgba(148, 163, 184, 0.1)'
              },
              min: 0.5,
              max: 3.5,
              ticks: {
                color: '#94a3b8',
                callback: function(value) {
                  const labels = ['', 'High Risk', 'Medium Risk', 'Low Risk'];
                  return labels[value] || '';
                },
                stepSize: 1
              }
            },
            y: {
              title: { 
                display: true, 
                text: 'Reward Potential',
                color: '#94a3b8'
              },
              grid: {
                color: 'rgba(148, 163, 184, 0.1)'
              },
              min: 0,
              max: 5,
              ticks: {
                color: '#94a3b8',
                stepSize: 1,
                callback: function(value) {
                  return value + '/5';
                }
              }
            }
          }
        }
      });
    }

    function renderComparisonTable() {
      const table = document.getElementById('comparison-table');
      table.innerHTML = '';

      const metrics = [
        { label: 'Industry', key: 'industry', format: (v, startup) => {
          const isDeck = !!(startup && (startup.is_deck_builder || startup.source_deck_id || startup.source_deck));
          const hasNoIndustry = !v || v === 'â€”' || v.trim() === '';
          
          if ((isDeck || hasNoIndustry) && startup && startup.tagline) {
            return escapeHtml(startup.tagline);
          }
          return escapeHtml(v || 'â€”');
        }},
        { label: 'Risk Level', key: 'risk_level', format: (v) => {
          if (!v) return 'â€”';
          if (v === 'Low') return '<span class="text-accent-400 font-medium">Low Risk</span>';
          if (v === 'Medium') return '<span class="text-yellow-400 font-medium">Medium Risk</span>';
          if (v === 'High') return '<span class="text-red-400 font-medium">High Risk</span>';
          return escapeHtml(v);
        }},
        { label: 'Estimated Growth Rate', key: 'estimated_growth_rate', format: (v) => {
          if (v == null) return 'â€”';
          const color = v >= 0 ? 'text-accent-400' : 'text-red-400';
          return `<span class="${color} font-semibold">${v >= 0 ? '+' : ''}${v}%</span>`;
        }},
        { label: 'Reward Potential', key: 'reward_potential', format: (v) => {
          const val = getRewardValue(v);
          return `<span class="font-semibold">${val}/5</span>`;
        }},
        { label: 'Revenue', key: 'revenue', format: (v) => v ? `${Number(v).toLocaleString()}` : 'â€”' }
      ];

      const thead = document.createElement('thead');
      thead.className = 'bg-slate-800';
      const headerRow = document.createElement('tr');
      headerRow.innerHTML = '<th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider sticky left-0 bg-slate-800 z-10">Metric</th>';
      startupsData.forEach(startup => {
        const th = document.createElement('th');
        th.className = 'px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider';
        th.textContent = startup.company_name;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      tbody.className = 'bg-slate-900/30 divide-y divide-slate-800';
      
      metrics.forEach((metric, idx) => {
        const row = document.createElement('tr');
        row.className = `table-row-hover ${idx % 2 === 0 ? 'bg-slate-900/30' : 'bg-slate-900/50'}`;
        
        const labelCell = document.createElement('td');
        labelCell.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-white sticky left-0 z-10';
        labelCell.style.backgroundColor = idx % 2 === 0 ? 'rgba(15, 23, 42, 0.3)' : 'rgba(15, 23, 42, 0.5)';
        labelCell.textContent = metric.label;
        row.appendChild(labelCell);

        startupsData.forEach(startup => {
          const cell = document.createElement('td');
          cell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-300';
          cell.innerHTML = metric.format(startup[metric.key], startup);
          row.appendChild(cell);
        });

        tbody.appendChild(row);
      });
      
      table.appendChild(tbody);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const token = getAuthToken();
      if (!token) {
        window.location.href = '/login';
        return;
      }
      
      const urlParams = new URLSearchParams(window.location.search);
      const fromSource = urlParams.get('from');
      const backNavLink = document.getElementById('back-nav-link');
      const backNavText = document.getElementById('back-nav-text');
      const backToSelectionContainer = document.getElementById('back-to-selection-container');
      
      if (fromSource === 'watchlist') {
        backNavLink.href = '../Module_1/Watchlist.html?tab=compared';
        backNavText.textContent = 'Back to Watchlist';
        backToSelectionContainer.classList.add('hidden');
      } else {
        backNavLink.href = '../Module_1/Dashboard.html';
        backNavText.textContent = 'Dashboard';
        backToSelectionContainer.classList.remove('hidden');
      }
      
      loadComparison();
    });
  </script>
</body>
</html>